<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Stochastic SIR Model • bayesSSM</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- katex math --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script><script src="../katex-auto.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Stochastic SIR Model">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">bayesSSM</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.7.0.9001</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/bayesSSM.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/detailed-overview.html">Detailed Overview of bayesSSM Package</a></li>
    <li><a class="dropdown-item" href="../articles/stochastic-sir-model.html">Stochastic SIR Model</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/BjarkeHautop/bayesSSM/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Stochastic SIR Model</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/BjarkeHautop/bayesSSM/blob/master/vignettes/articles/stochastic-sir-model.Rmd" class="external-link"><code>vignettes/articles/stochastic-sir-model.Rmd</code></a></small>
      <div class="d-none name"><code>stochastic-sir-model.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/BjarkeHautop/bayesSSM" class="external-link">bayesSSM</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/twolodzko/extraDistr" class="external-link">extraDistr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://R-Forge.R-project.org/projects/expm/" class="external-link">expm</a></span><span class="op">)</span> <span class="co"># For matrix exponentiation</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1405</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="stochastic-sir-model">Stochastic SIR Model<a class="anchor" aria-label="anchor" href="#stochastic-sir-model"></a>
</h2>
<p>We consider a stochastic SIR (Susceptible–Infectious–Recovered) model
for the spread of an infectious disease in a <em>closed population</em>
of size <span class="math inline">pop_size</span>, meaning there are no
births, deaths, or migration. The population is divided into three
compartments: susceptible (S), infectious (I), and recovered (R).
Initially, all individuals are susceptible except for <span class="math inline">m</span> infectious individuals.</p>
<p>Note that most of the literature on SIR models assumes a
deterministic model, where the compartments are treated as continuous
and are described by ordinary differential equations (ODEs). Here, we
instead consider a fully stochastic model, where the compartments are
discrete and the transitions between compartments are governed by
probabilistic rules. Especially for small populations, stochastic models
can capture the inherent randomness in disease transmission and recovery
more accurately than deterministic models.</p>
<p>Each infectious individual makes contact with any given member of the
population according to a time-homogeneous Poisson process with rate
<span class="math inline">\lambda/pop_size</span>, where <span class="math inline">\lambda &gt; 0</span>. Thus, each infectious
individual makes contact with any other individual at an overall rate of
<span class="math inline">\lambda</span>, independent of the population
size.</p>
<p>The duration of the infectious period for each individual is assumed
to follow an exponential distribution: <span class="math display">
I \sim \text{Exp}(\gamma),
</span> where <span class="math inline">\gamma &gt; 0</span> is the
recovery rate.</p>
<p>Let <span class="math inline">S(t)</span> and <span class="math inline">I(t)</span> denote the number of susceptible and
infectious individuals at time <span class="math inline">t \geq
0</span>, respectively. Under the assumptions above, the process <span class="math display">
\{(S(t), I(t)) : t \geq 0\}
</span> forms a continuous-time Markov process, since both infection and
recovery events are exponentially distributed and are therefore
memoryless. Since <span class="math inline">pop_size</span> is fixed, we
have <span class="math inline">R(t) = pop_size - S(t) - I(t)</span>, and
thus the process can be described by the pair <span class="math inline">(S(t), I(t))</span>.</p>
<div class="section level3">
<h3 id="transition-rates">Transition Rates<a class="anchor" aria-label="anchor" href="#transition-rates"></a>
</h3>
<ul>
<li>
<p><strong>Infection Event:</strong></p>
<p><span class="math display">
(s, i, r) \to (s - 1, i + 1, r)
</span></p>
<p>occurs at rate</p>
<p><span class="math display">
\frac{\lambda}{pop_size} \, s \, i,
</span></p>
<p>for <span class="math inline">s &gt; 0</span> and <span class="math inline">i &gt; 0</span>.</p>
</li>
<li>
<p><strong>Recovery Event:</strong></p>
<p><span class="math display">
(s, i, r) \to (s, i - 1, r + 1)
</span></p>
<p>occurs at rate</p>
<p><span class="math display">
\gamma \, i,
</span></p>
<p>for <span class="math inline">i &gt; 0</span>.</p>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="partial-observations-and-noisy-measurements">Partial Observations and Noisy Measurements<a class="anchor" aria-label="anchor" href="#partial-observations-and-noisy-measurements"></a>
</h3>
<p>Suppose we only observe the initial state and the number of
infectious individuals <span class="math inline">I(t)</span> at discrete
time points <span class="math inline">t = 0, 1, \ldots, T</span>. The
true number of infectious individuals is unobserved (latent), and
instead we observe a noisy measurement that may either overestimate or
underestimate the true count.</p>
<p>We model the observed counts <span class="math inline">Y_t</span> in
this article using a Poisson observation model: <span class="math display">
Y_t \mid I(t) \sim \operatorname{Pois}(I(t)).
</span> To account for over-dispersion, one could instead use a negative
binomial observation model.</p>
<p>We are now in a State Space Model (SSM) setup, where the latent state
is <span class="math inline">\bigl(S(t), I(t)\bigr)</span>, and the
observations are <span class="math inline">Y_t</span>. Note that due to
the memoryless property of the exponential distribution, the latent
state <span class="math inline">(S(t), I(t))</span> is fully determined
by the initial state and the sequence of infection and recovery events
that have occurred up to time <span class="math inline">t</span>, thus a
Markov process.</p>
</div>
</div>
<div class="section level2">
<h2 id="why-standard-mcmc-methods-are-infeasible">Why Standard MCMC Methods Are Infeasible<a class="anchor" aria-label="anchor" href="#why-standard-mcmc-methods-are-infeasible"></a>
</h2>
<p>If one wanted to use standard MCMC methods to estimate the joint
posterior of the parameters and latent states, one would need to compute
the exact transition probabilities for the SIR model, which quickly
becomes infeasible as the number of infectious individuals increases. We
illustrate how this can be done using matrix exponentiation for small
populations.</p>
<p>The probability distribution of the state at time <span class="math inline">t</span> is given by: <span class="math display">
matrix_exp(t) = e^{Qt},
</span> where <span class="math inline">generator</span> is the
generator matrix of the Markov process, which contains the transition
rates between states.</p>
<p>We define functions below to generate the state space for a small SIR
system, build the generator matrix, and compute the transition
probabilities at a given time <span class="math inline">t</span>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate state space for small SIR system</span></span>
<span><span class="va">generate_sir_states</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pop_size</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Returns all (s, i) pairs where s + i &lt;= pop_size</span></span>
<span>  <span class="va">states</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>s <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="va">pop_size</span>, i <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="va">pop_size</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">s</span> <span class="op">+</span> <span class="va">.data</span><span class="op">$</span><span class="va">i</span> <span class="op">&lt;=</span> <span class="va">pop_size</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">s</span>, <span class="va">.data</span><span class="op">$</span><span class="va">i</span><span class="op">)</span></span>
<span>  <span class="va">states</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Build generator matrix</span></span>
<span><span class="va">build_generator_matrix</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">states</span>, <span class="va">lambda</span>, <span class="va">gamma</span>, <span class="va">pop_size</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">n_states</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">states</span><span class="op">)</span></span>
<span>  <span class="va">generator</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n_states</span>, <span class="va">n_states</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_states</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">s</span> <span class="op">&lt;-</span> <span class="va">states</span><span class="op">$</span><span class="va">s</span><span class="op">[</span><span class="va">k</span><span class="op">]</span></span>
<span>    <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">states</span><span class="op">$</span><span class="va">i</span><span class="op">[</span><span class="va">k</span><span class="op">]</span></span>
<span></span>
<span>    <span class="va">rate_infection</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">lambda</span> <span class="op">/</span> <span class="va">pop_size</span><span class="op">)</span> <span class="op">*</span> <span class="va">s</span> <span class="op">*</span> <span class="va">i</span></span>
<span>    <span class="va">rate_recovery</span> <span class="op">&lt;-</span> <span class="va">gamma</span> <span class="op">*</span> <span class="va">i</span></span>
<span></span>
<span>    <span class="co"># Infection transition</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">s</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">&amp;&amp;</span> <span class="va">i</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">next_state</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">s</span> <span class="op">-</span> <span class="fl">1</span>, <span class="va">i</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span>      <span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">states</span><span class="op">$</span><span class="va">s</span> <span class="op">==</span> <span class="va">next_state</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&amp;</span> <span class="va">states</span><span class="op">$</span><span class="va">i</span> <span class="op">==</span> <span class="va">next_state</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">generator</span><span class="op">[</span><span class="va">k</span>, <span class="va">idx</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rate_infection</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># Recovery transition</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">i</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">next_state</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">s</span>, <span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span>      <span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">states</span><span class="op">$</span><span class="va">s</span> <span class="op">==</span> <span class="va">next_state</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&amp;</span> <span class="va">states</span><span class="op">$</span><span class="va">i</span> <span class="op">==</span> <span class="va">next_state</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">generator</span><span class="op">[</span><span class="va">k</span>, <span class="va">idx</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rate_recovery</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># Diagonal: exit rate</span></span>
<span>    <span class="va">generator</span><span class="op">[</span><span class="va">k</span>, <span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="op">(</span><span class="va">rate_infection</span> <span class="op">+</span> <span class="va">rate_recovery</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">generator</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Compute transition probabilities at time t</span></span>
<span><span class="va">compute_transition_probs</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">lambda</span>, <span class="va">gamma</span>, <span class="va">pop_size</span>, <span class="va">t</span>, <span class="va">init_state</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">states</span> <span class="op">&lt;-</span> <span class="fu">generate_sir_states</span><span class="op">(</span><span class="va">pop_size</span><span class="op">)</span></span>
<span>  <span class="va">generator</span> <span class="op">&lt;-</span> <span class="fu">build_generator_matrix</span><span class="op">(</span><span class="va">states</span>, <span class="va">lambda</span>, <span class="va">gamma</span>, <span class="va">pop_size</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">matrix_exp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/expm/man/expm.html" class="external-link">expm</a></span><span class="op">(</span><span class="va">generator</span> <span class="op">*</span> <span class="va">t</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">init_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">states</span><span class="op">$</span><span class="va">s</span> <span class="op">==</span> <span class="va">init_state</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&amp;</span> <span class="va">states</span><span class="op">$</span><span class="va">i</span> <span class="op">==</span> <span class="va">init_state</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">p_t</span> <span class="op">&lt;-</span> <span class="va">matrix_exp</span><span class="op">[</span><span class="va">init_index</span>, <span class="op">]</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    s <span class="op">=</span> <span class="va">states</span><span class="op">$</span><span class="va">s</span>,</span>
<span>    i <span class="op">=</span> <span class="va">states</span><span class="op">$</span><span class="va">i</span>,</span>
<span>    prob <span class="op">=</span> <span class="va">p_t</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This can then be run to compute the transition probabilities for a
given state and time point. For example, if we have a population of size
<span class="math inline">pop_size=5</span> with state <span class="math inline">(S(t), I(t)) = (4, 1)</span> at time <span class="math inline">t</span>, we can compute the transition
probabilities for the next time point <span class="math inline">t+1</span> as</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example with very small population</span></span>
<span><span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fl">1.0</span></span>
<span><span class="va">gamma</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span>
<span><span class="va">pop_size</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">init_state</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">1</span><span class="op">)</span> <span class="co"># (s, i)</span></span>
<span></span>
<span><span class="va">transition_probs</span> <span class="op">&lt;-</span> <span class="fu">compute_transition_probs</span><span class="op">(</span></span>
<span>  <span class="va">lambda</span>, <span class="va">gamma</span>, <span class="va">pop_size</span>, <span class="va">t</span>, <span class="va">init_state</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Show the most probable next states</span></span>
<span><span class="va">transition_probs</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">transition_probs</span><span class="op">$</span><span class="va">prob</span><span class="op">)</span>, <span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="op">]</span></span>
<span><span class="co">#&gt;    s i       prob</span></span>
<span><span class="co">#&gt; 19 4 0 0.27979546</span></span>
<span><span class="co">#&gt; 20 4 1 0.27253179</span></span>
<span><span class="co">#&gt; 18 3 2 0.14375879</span></span>
<span><span class="co">#&gt; 17 3 1 0.08872580</span></span>
<span><span class="co">#&gt; 15 2 3 0.06343076</span></span></code></pre></div>
<p>Note, that this scales poorly with larger populations, as the number
of states is given by <span class="math display">
\text{pop_size}+2 \choose 2,
</span> which for <span class="math inline">pop_size=100</span> is
already over <span class="math inline">5000</span> states. Thus, this
whole approach is only feasible for very small populations.</p>
</div>
<div class="section level2">
<h2 id="simulate-data">Simulate data<a class="anchor" aria-label="anchor" href="#simulate-data"></a>
</h2>
<p>We will simulate data from the SIR model with the following
parameters:</p>
<ul>
<li><p>At <span class="math inline">t=0</span> we have <span class="math inline">S(0) = 90</span>, <span class="math inline">I(0) =
10</span> and <span class="math inline">R(0) = 0</span>.</p></li>
<li><p>Infection rate <span class="math inline">\lambda=1.5</span> and
removal rate <span class="math inline">\gamma=0.5</span>.</p></li>
<li><p>We observe the initial state at <span class="math inline">t=0</span> complete, and then noisy version of
infectious individuals at times <span class="math inline">t=1, \ldots,
10</span> representing observations for each day.</p></li>
</ul>
<p>We can simulate using the fact that we have two independent
exponential distribution, so an event occurs at rate of the sum of the
rates.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># --- Simulation settings and true parameters ---</span></span>
<span><span class="va">n_total</span> <span class="op">&lt;-</span> <span class="fl">500</span> <span class="co"># Total population size</span></span>
<span><span class="va">init_infected</span> <span class="op">&lt;-</span> <span class="fl">70</span> <span class="co"># Initially infectious individuals</span></span>
<span><span class="va">init_state</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_total</span> <span class="op">-</span> <span class="va">init_infected</span>, <span class="va">init_infected</span><span class="op">)</span> <span class="co"># (s, i) at time 0</span></span>
<span><span class="va">t_max</span> <span class="op">&lt;-</span> <span class="fl">10</span> <span class="co"># Total number of days to simulate</span></span>
<span><span class="va">true_lambda</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="co"># True infection parameter</span></span>
<span><span class="va">true_gamma</span> <span class="op">&lt;-</span> <span class="fl">0.2</span> <span class="co"># True removal parameter</span></span>
<span></span>
<span><span class="co"># --- Functions for simulating the epidemic ---</span></span>
<span></span>
<span><span class="va">epidemic_step</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">state</span>, <span class="va">lambda</span>, <span class="va">gamma</span>, <span class="va">n_total</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">t</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">t_end</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  <span class="va">s</span> <span class="op">&lt;-</span> <span class="va">state</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">state</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="kw">while</span> <span class="op">(</span><span class="va">t</span> <span class="op">&lt;</span> <span class="va">t_end</span> <span class="op">&amp;&amp;</span> <span class="va">i</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">rate_infection</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">lambda</span> <span class="op">/</span> <span class="va">n_total</span><span class="op">)</span> <span class="op">*</span> <span class="va">s</span> <span class="op">*</span> <span class="va">i</span></span>
<span>    <span class="va">rate_removal</span> <span class="op">&lt;-</span> <span class="va">gamma</span> <span class="op">*</span> <span class="va">i</span></span>
<span>    <span class="va">rate_total</span> <span class="op">&lt;-</span> <span class="va">rate_infection</span> <span class="op">+</span> <span class="va">rate_removal</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">rate_total</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">)</span> <span class="kw">break</span></span>
<span>    <span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">rate_total</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">t</span> <span class="op">+</span> <span class="va">dt</span> <span class="op">&gt;</span> <span class="va">t_end</span><span class="op">)</span> <span class="kw">break</span></span>
<span>    <span class="va">t</span> <span class="op">&lt;-</span> <span class="va">t</span> <span class="op">+</span> <span class="va">dt</span></span>
<span>    <span class="co"># Decide which event occurs:</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">rate_infection</span> <span class="op">/</span> <span class="va">rate_total</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Infection event</span></span>
<span>      <span class="va">s</span> <span class="op">&lt;-</span> <span class="va">s</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>      <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">i</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="co"># Removal event</span></span>
<span>      <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">i</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">s</span>, <span class="va">i</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">simulate_epidemic</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>  <span class="va">n_total</span>, <span class="va">init_infected</span>, <span class="va">lambda</span>, <span class="va">gamma</span>, <span class="va">t_max</span></span>
<span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">states</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">t_max</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="co"># initial state at t = 0</span></span>
<span>  <span class="va">state</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_total</span> <span class="op">-</span> <span class="va">init_infected</span>, <span class="va">init_infected</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">t_max</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">state</span> <span class="op">&lt;-</span> <span class="fu">epidemic_step</span><span class="op">(</span><span class="va">state</span>, <span class="va">lambda</span>, <span class="va">gamma</span>, <span class="va">n_total</span><span class="op">)</span></span>
<span>    <span class="va">states</span><span class="op">[</span><span class="va">t</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">state</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">states</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now, we generate some data:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Simulate an epidemic dataset</span></span>
<span><span class="va">true_states</span> <span class="op">&lt;-</span> <span class="fu">simulate_epidemic</span><span class="op">(</span></span>
<span>  <span class="va">n_total</span>, <span class="va">init_infected</span>, <span class="va">true_lambda</span>, <span class="va">true_gamma</span>, <span class="va">t_max</span></span>
<span><span class="op">)</span></span>
<span><span class="va">latent_i</span> <span class="op">&lt;-</span> <span class="va">true_states</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span></span>
<span></span>
<span><span class="va">observations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">latent_i</span><span class="op">)</span>, lambda <span class="op">=</span> <span class="va">latent_i</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Display simulated data: time, susceptible, latent infectious, observed counts</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  time <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">t_max</span>, s <span class="op">=</span> <span class="va">true_states</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, i <span class="op">=</span> <span class="va">true_states</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, y <span class="op">=</span> <span class="va">observations</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    time   s   i   y</span></span>
<span><span class="co">#&gt; 1     1 391  88 103</span></span>
<span><span class="co">#&gt; 2     2 348 113 106</span></span>
<span><span class="co">#&gt; 3     3 307 132 114</span></span>
<span><span class="co">#&gt; 4     4 266 147 136</span></span>
<span><span class="co">#&gt; 5     5 221 164 155</span></span>
<span><span class="co">#&gt; 6     6 183 171 168</span></span>
<span><span class="co">#&gt; 7     7 155 159 154</span></span>
<span><span class="co">#&gt; 8     8 137 143 137</span></span>
<span><span class="co">#&gt; 9     9 118 139 147</span></span>
<span><span class="co">#&gt; 10   10 107 121 123</span></span></code></pre></div>
<p>And plot it:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Function to create a tidy dataset for ggplot</span></span>
<span><span class="va">prepare_data_for_plot</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">states</span>, <span class="va">observations</span>, <span class="va">t_max</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Organize the data into a tidy format</span></span>
<span>  <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    time <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">t_max</span>,</span>
<span>    s <span class="op">=</span> <span class="va">states</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>,</span>
<span>    i <span class="op">=</span> <span class="va">states</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>,</span>
<span>    y <span class="op">=</span> <span class="va">observations</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Convert to long format for ggplot</span></span>
<span>  <span class="va">data_long</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html" class="external-link">gather</a></span><span class="op">(</span>key <span class="op">=</span> <span class="st">"state"</span>, value <span class="op">=</span> <span class="st">"count"</span>, <span class="op">-</span><span class="va">time</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">data_long</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Function to plot the epidemic data</span></span>
<span><span class="va">plot_epidemic_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data_long</span>, <span class="va">t_max</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data_long</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">time</span>, y <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">count</span>, color <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">state</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"s"</span> <span class="op">=</span> <span class="st">"blue"</span>, <span class="st">"i"</span> <span class="op">=</span> <span class="st">"red"</span>, <span class="st">"y"</span> <span class="op">=</span> <span class="st">"green"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="st">"Time (Days)"</span>, y <span class="op">=</span> <span class="st">"Count"</span>,</span>
<span>      title <span class="op">=</span> <span class="st">"Susceptible, Infected, and Observed Counts"</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">t_max</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>      axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>      plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span>, hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Prepare data for plotting</span></span>
<span><span class="va">data_long</span> <span class="op">&lt;-</span> <span class="fu">prepare_data_for_plot</span><span class="op">(</span><span class="va">true_states</span>, <span class="va">observations</span>, <span class="va">t_max</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the results</span></span>
<span><span class="fu">plot_epidemic_data</span><span class="op">(</span><span class="va">data_long</span>, <span class="va">t_max</span><span class="op">)</span></span></code></pre></div>
<p><img src="stochastic-sir-model_files/figure-html/plot-simulated-data-1.png" alt="Simulated epidemic data" width="576"></p>
</div>
<div class="section level2">
<h2 id="bayesian-inference-with-pmmh">Bayesian Inference with PMMH<a class="anchor" aria-label="anchor" href="#bayesian-inference-with-pmmh"></a>
</h2>
<p>We are interested in performing Bayesian inference in this setup, and
define the priors as follows: <span class="math display">\begin{align*}
    \lambda &amp;\sim \operatorname{Normal^+}(0, 1^2), \\
    \gamma &amp;\sim \operatorname{Normal^+}(0, 2^2),
\end{align*}</span> where <span class="math inline">\operatorname{Normal^+}</span> denotes a truncated
at <span class="math inline">0</span> normal distribution.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define the log-prior for the parameters</span></span>
<span><span class="va">log_prior_lambda</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">lambda</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">extraDistr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/extraDistr/man/HalfNormal.html" class="external-link">dhnorm</a></span><span class="op">(</span><span class="va">lambda</span>, sigma <span class="op">=</span> <span class="fl">1</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">log_prior_gamma</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">gamma</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">extraDistr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/extraDistr/man/HalfNormal.html" class="external-link">dhnorm</a></span><span class="op">(</span><span class="va">gamma</span>, sigma <span class="op">=</span> <span class="fl">2</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">log_priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  lambda <span class="op">=</span> <span class="va">log_prior_lambda</span>,</span>
<span>  gamma <span class="op">=</span> <span class="va">log_prior_gamma</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We now define the initial state, transition and likelihood functions
for the SIR model.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">init_fn_epidemic</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">num_particles</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Return a matrix with particles rows; each row is the initial state (s, i)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">init_state</span>, each <span class="op">=</span> <span class="va">num_particles</span><span class="op">)</span>,</span>
<span>    nrow <span class="op">=</span> <span class="va">num_particles</span>,</span>
<span>    byrow <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">transition_fn_epidemic</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">particles</span>, <span class="va">lambda</span>, <span class="va">gamma</span>, <span class="va">t</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">new_particles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">particles</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">s</span> <span class="op">&lt;-</span> <span class="va">state</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>    <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">state</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">s</span>, <span class="va">i</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu">epidemic_step</span><span class="op">(</span><span class="va">state</span>, <span class="va">lambda</span>, <span class="va">gamma</span>, <span class="va">n_total</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">new_particles</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">log_likelihood_fn_epidemic</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span>, <span class="va">particles</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># particles is expected to be a matrix with columns (s, i)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">dpois</a></span><span class="op">(</span><span class="va">y</span>, lambda <span class="op">=</span> <span class="va">particles</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now we can run the PMMH algorithm to estimate the posterior
distribution. For this vignette we only use a small number of iterations
(1000) and 2 chains (and we also modify the tuning to only use 100
iterations with a burn-in of 10). In practice, these should be much
higher.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">bayesSSM</span><span class="fu">::</span><span class="fu"><a href="../reference/pmmh.html">pmmh</a></span><span class="op">(</span></span>
<span>  pf_wrapper <span class="op">=</span> <span class="va">bootstrap_filter</span>, <span class="co"># use bootstrap particle filter</span></span>
<span>  y <span class="op">=</span> <span class="va">observations</span>,</span>
<span>  m <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  init_fn <span class="op">=</span> <span class="va">init_fn_epidemic</span>,</span>
<span>  transition_fn <span class="op">=</span> <span class="va">transition_fn_epidemic</span>,</span>
<span>  log_likelihood_fn <span class="op">=</span> <span class="va">log_likelihood_fn_epidemic</span>,</span>
<span>  log_priors <span class="op">=</span> <span class="va">log_priors</span>,</span>
<span>  pilot_init_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="fl">0.5</span>, gamma <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="fl">1</span>, gamma <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  burn_in <span class="op">=</span> <span class="fl">200</span>,</span>
<span>  num_chains <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  param_transform <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="st">"log"</span>, gamma <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>,</span>
<span>  tune_control <span class="op">=</span> <span class="fu"><a href="../reference/default_tune_control.html">default_tune_control</a></span><span class="op">(</span>pilot_m <span class="op">=</span> <span class="fl">100</span>, pilot_burn_in <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">1405</span>,</span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Running chain 1...</span></span>
<span><span class="co">#&gt; Running pilot chain for tuning...</span></span>
<span><span class="co">#&gt; Pilot chain posterior mean:</span></span>
<span><span class="co">#&gt;    lambda     gamma </span></span>
<span><span class="co">#&gt; 0.5317352 0.1822626</span></span>
<span><span class="co">#&gt; Pilot chain posterior covariance (transformed space):</span></span>
<span><span class="co">#&gt;             lambda       gamma</span></span>
<span><span class="co">#&gt; lambda 0.015968002 0.004597379</span></span>
<span><span class="co">#&gt; gamma  0.004597379 0.001364845</span></span>
<span><span class="co">#&gt; Using 50 particles for PMMH:</span></span>
<span><span class="co">#&gt; Running Particle MCMC chain with tuned settings...</span></span>
<span><span class="co">#&gt; Running chain 2...</span></span>
<span><span class="co">#&gt; Running pilot chain for tuning...</span></span>
<span><span class="co">#&gt; Pilot chain posterior mean:</span></span>
<span><span class="co">#&gt;    lambda     gamma </span></span>
<span><span class="co">#&gt; 0.4623588 0.1752997</span></span>
<span><span class="co">#&gt; Pilot chain posterior covariance (transformed space):</span></span>
<span><span class="co">#&gt;               lambda         gamma</span></span>
<span><span class="co">#&gt; lambda  0.0019022254 -2.446075e-04</span></span>
<span><span class="co">#&gt; gamma  -0.0002446075  4.555458e-05</span></span>
<span><span class="co">#&gt; Using 50 particles for PMMH:</span></span>
<span><span class="co">#&gt; Running Particle MCMC chain with tuned settings...</span></span>
<span><span class="co">#&gt; PMMH Results Summary:</span></span>
<span><span class="co">#&gt;  Parameter Mean   SD Median 2.5% 97.5% ESS  Rhat</span></span>
<span><span class="co">#&gt;     lambda 0.59 0.08   0.59 0.43  0.75  39 1.089</span></span>
<span><span class="co">#&gt;      gamma 0.21 0.02   0.22 0.16  0.25  15 1.082</span></span>
<span><span class="co">#&gt; Warning in bayesSSM::pmmh(pf_wrapper = bootstrap_filter, y = observations, :</span></span>
<span><span class="co">#&gt; Some ESS values are below 400, indicating poor mixing. Consider running the</span></span>
<span><span class="co">#&gt; chains for more iterations.</span></span>
<span><span class="co">#&gt; Warning in bayesSSM::pmmh(pf_wrapper = bootstrap_filter, y = observations, : </span></span>
<span><span class="co">#&gt; Some Rhat values are above 1.01, indicating that the chains have not converged. </span></span>
<span><span class="co">#&gt; Consider running the chains for more iterations and/or increase burn_in.</span></span></code></pre></div>
<p>We get convergence warnings as expected, but the posterior is still
centered around the true value.</p>
<p>We can access the chains and plot the densities:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chains</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">$</span><span class="va">theta_chain</span></span></code></pre></div>
<p>For <span class="math inline">\lambda</span>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">chains</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">lambda</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">chain</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Density plot of lambda chains"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Value"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Density"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"Chain"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="stochastic-sir-model_files/figure-html/lambda-plot-1.png" alt="Density plot of lambda chains" width="576"></p>
<p>And for <span class="math inline">\gamma</span>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">chains</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">gamma</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">chain</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Density plot of gamma chains"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Value"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Density"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"Chain"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="stochastic-sir-model_files/figure-html/gamma-plot-1.png" alt="Density plot of gamma chains" width="576"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Bjarke Hautop.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
