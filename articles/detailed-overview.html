<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Detailed Overview of bayesSSM Package • bayesSSM</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- katex math --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script><script src="../katex-auto.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Detailed Overview of bayesSSM Package">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">bayesSSM</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.1.9002</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/bayesSSM.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/detailed-overview.html">Detailed Overview of bayesSSM Package</a></li>
    <li><a class="dropdown-item" href="../articles/stochastic-sir-model.html">Stochastic SIR Model</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/BjarkeHautop/bayesSSM/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Detailed Overview of bayesSSM Package</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/BjarkeHautop/bayesSSM/blob/master/vignettes/articles/detailed-overview.Rmd" class="external-link"><code>vignettes/articles/detailed-overview.Rmd</code></a></small>
      <div class="d-none name"><code>detailed-overview.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/BjarkeHautop/bayesSSM" class="external-link">bayesSSM</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.rcpp.org" class="external-link">Rcpp</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/twolodzko/extraDistr" class="external-link">extraDistr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1405</span><span class="op">)</span></span></code></pre></div>
<p>In this article, we will provide a detailed overview of the
<code>bayesSSM</code> package. It will include some brief theoretical
background and tips on how to use the package effectively.</p>
<div class="section level2">
<h2 id="theoretical-background">Theoretical Background<a class="anchor" aria-label="anchor" href="#theoretical-background"></a>
</h2>
<p>The <code>bayesSSM</code> package is designed to facilitate Bayesian
inference for state space models (SSMs). This package defines a state
space model as in the diagram below (where potential time dependency is
not shown for simplicity):</p>
<p>We wish to perform Bayesian inference in this setting, that is the
target distribution is <span class="math display">
p(x_{0:T}, \theta \mid y_{1:T}) \propto \pi(\theta) \, p(x_{0:T} \mid
\theta)
\, p(y_{1:T} \mid x_{0:T}, \theta),
</span> where <span class="math inline">\pi(\theta)</span> is the prior
distribution of the parameters <span class="math inline">\theta</span>,
<span class="math inline">p(x_{0:T} \mid \theta)</span> is the
distribution of the latent states, and <span class="math inline">p(y_{1:T} \mid x_{0:T}, \theta)</span> is the
distribution of the observations given the latent states and
parameters.</p>
<p>Some naive MCMC approaches would be to sample <span class="math inline">(x_{0:T}, \theta)</span> jointly, but this is often
infeasible due to the high dimensionality of the latent states. Another
approach would be to marginalize out the latent states and sample the
parameters <span class="math inline">\theta</span>, but this is also
often infeasible due to the integral being intractable.</p>
<p>Instead, we use a Particle Markov chain Monte Carlo (PMMH) approach,
which samples the latent states and parameters in two steps:</p>
<ol style="list-style-type: decimal">
<li>Sample the latent states <span class="math inline">x_{0:T}</span>
given the parameters <span class="math inline">\theta</span> and the
observations <span class="math inline">y_{1:T}</span> using a particle
filter.</li>
<li>Sample the parameters <span class="math inline">\theta</span> given
the latent states <span class="math inline">x_{0:T}</span> and the
observations <span class="math inline">y_{1:T}</span> using a
Metropolis-Hastings step.</li>
</ol>
<p>The key idea is that, since the particle filter provides an unbiased
estimate of the likelihood, the PMMH algorithm still targets the correct
posterior distribution as its stationary distribution.</p>
<p>To avoid weight degeneracy in the particle filter, it is recommended
to use resampling, to focus on the particles with higher weights (with
high probability).</p>
</div>
<div class="section level2">
<h2 id="example-fitting-a-state-space-model">Example: Fitting a State Space Model<a class="anchor" aria-label="anchor" href="#example-fitting-a-state-space-model"></a>
</h2>
<p>We will show how to fit a stochastic SIR model using the
<code>bayesSSM</code> package ( see also the stochastic-sir-model
article <a href="https://bjarkehautop.github.io/bayesSSM/articles/stochastic-sir-model.html">here</a>
for more details). First, we will generate some synthetic data from the
model.</p>
<div class="section level3">
<h3 id="simulate-data">Simulate data<a class="anchor" aria-label="anchor" href="#simulate-data"></a>
</h3>
<p>We will simulate data from the SIR model with the following
parameters:</p>
<ul>
<li>At <span class="math inline">t=0</span> we have <span class="math inline">S(0) = 90</span>, <span class="math inline">I(0) =
10</span> and <span class="math inline">R(0) = 0</span>.</li>
<li>Infection rate <span class="math inline">\lambda=0.5</span> and
removal rate <span class="math inline">\gamma=0.2</span>.</li>
<li>We observe the initial state at <span class="math inline">t=0</span>
complete, and then noisy version of infectious individuals at times
<span class="math inline">t=1, \ldots, 10</span> representing
observations for each day.</li>
</ul>
<p>We can simulate using the fact that we have two independent
exponential distribution, so an event occurs at rate of the sum of the
rates.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># --- Simulation settings and true parameters ---</span></span>
<span><span class="va">n_total</span> <span class="op">&lt;-</span> <span class="fl">500</span> <span class="co"># Total population size</span></span>
<span><span class="va">init_infected</span> <span class="op">&lt;-</span> <span class="fl">70</span> <span class="co"># Initially infectious individuals</span></span>
<span><span class="va">init_state</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_total</span> <span class="op">-</span> <span class="va">init_infected</span>, <span class="va">init_infected</span><span class="op">)</span> <span class="co"># (s, i) at time 0</span></span>
<span><span class="va">t_max</span> <span class="op">&lt;-</span> <span class="fl">10</span> <span class="co"># Total number of days to simulate</span></span>
<span><span class="va">true_lambda</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="co"># True infection parameter</span></span>
<span><span class="va">true_gamma</span> <span class="op">&lt;-</span> <span class="fl">0.2</span> <span class="co"># True removal parameter</span></span>
<span></span>
<span><span class="co"># --- Functions for simulating the epidemic ---</span></span>
<span></span>
<span><span class="va">epidemic_step</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">state</span>, <span class="va">lambda</span>, <span class="va">gamma</span>, <span class="va">n_total</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">t</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">t_end</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  <span class="va">s</span> <span class="op">&lt;-</span> <span class="va">state</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">state</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="kw">while</span> <span class="op">(</span><span class="va">t</span> <span class="op">&lt;</span> <span class="va">t_end</span> <span class="op">&amp;&amp;</span> <span class="va">i</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">rate_infection</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">lambda</span> <span class="op">/</span> <span class="va">n_total</span><span class="op">)</span> <span class="op">*</span> <span class="va">s</span> <span class="op">*</span> <span class="va">i</span></span>
<span>    <span class="va">rate_removal</span> <span class="op">&lt;-</span> <span class="va">gamma</span> <span class="op">*</span> <span class="va">i</span></span>
<span>    <span class="va">rate_total</span> <span class="op">&lt;-</span> <span class="va">rate_infection</span> <span class="op">+</span> <span class="va">rate_removal</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">rate_total</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">)</span> <span class="kw">break</span></span>
<span>    <span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">rate_total</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">t</span> <span class="op">+</span> <span class="va">dt</span> <span class="op">&gt;</span> <span class="va">t_end</span><span class="op">)</span> <span class="kw">break</span></span>
<span>    <span class="va">t</span> <span class="op">&lt;-</span> <span class="va">t</span> <span class="op">+</span> <span class="va">dt</span></span>
<span>    <span class="co"># Decide which event occurs:</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">rate_infection</span> <span class="op">/</span> <span class="va">rate_total</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Infection event</span></span>
<span>      <span class="va">s</span> <span class="op">&lt;-</span> <span class="va">s</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>      <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">i</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="co"># Removal event</span></span>
<span>      <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">i</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">s</span>, <span class="va">i</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">simulate_epidemic</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">n_total</span>, <span class="va">init_infected</span>, <span class="va">lambda</span>, <span class="va">gamma</span>, <span class="va">t_max</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">states</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">t_max</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="co"># initial state at t = 0</span></span>
<span>  <span class="va">state</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_total</span> <span class="op">-</span> <span class="va">init_infected</span>, <span class="va">init_infected</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">t_max</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">state</span> <span class="op">&lt;-</span> <span class="fu">epidemic_step</span><span class="op">(</span><span class="va">state</span>, <span class="va">lambda</span>, <span class="va">gamma</span>, <span class="va">n_total</span><span class="op">)</span></span>
<span>    <span class="va">states</span><span class="op">[</span><span class="va">t</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">state</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">states</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now, we generate some data:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Simulate an epidemic dataset</span></span>
<span><span class="va">true_states</span> <span class="op">&lt;-</span> <span class="fu">simulate_epidemic</span><span class="op">(</span></span>
<span>  <span class="va">n_total</span>, <span class="va">init_infected</span>, <span class="va">true_lambda</span>, <span class="va">true_gamma</span>, <span class="va">t_max</span></span>
<span><span class="op">)</span></span>
<span><span class="va">latent_i</span> <span class="op">&lt;-</span> <span class="va">true_states</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span></span>
<span></span>
<span><span class="va">observations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">latent_i</span><span class="op">)</span>, lambda <span class="op">=</span> <span class="va">latent_i</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Display simulated data: time, susceptible, latent infectious, observed counts</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  time <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">t_max</span>, s <span class="op">=</span> <span class="va">true_states</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, i <span class="op">=</span> <span class="va">true_states</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, y <span class="op">=</span> <span class="va">observations</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    time   s   i   y</span></span>
<span><span class="co">#&gt; 1     1 391  88 103</span></span>
<span><span class="co">#&gt; 2     2 348 113 106</span></span>
<span><span class="co">#&gt; 3     3 307 132 114</span></span>
<span><span class="co">#&gt; 4     4 266 147 136</span></span>
<span><span class="co">#&gt; 5     5 221 164 155</span></span>
<span><span class="co">#&gt; 6     6 183 171 168</span></span>
<span><span class="co">#&gt; 7     7 155 159 154</span></span>
<span><span class="co">#&gt; 8     8 137 143 137</span></span>
<span><span class="co">#&gt; 9     9 118 139 147</span></span>
<span><span class="co">#&gt; 10   10 107 121 123</span></span></code></pre></div>
<p>And plot it:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Function to create a tidy dataset for ggplot</span></span>
<span><span class="va">prepare_data_for_plot</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">states</span>, <span class="va">observations</span>, <span class="va">t_max</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Organize the data into a tidy format</span></span>
<span>  <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    time <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">t_max</span>,</span>
<span>    s <span class="op">=</span> <span class="va">states</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>,</span>
<span>    i <span class="op">=</span> <span class="va">states</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>,</span>
<span>    y <span class="op">=</span> <span class="va">observations</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Convert to long format for ggplot</span></span>
<span>  <span class="va">data_long</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html" class="external-link">gather</a></span><span class="op">(</span>key <span class="op">=</span> <span class="st">"state"</span>, value <span class="op">=</span> <span class="st">"count"</span>, <span class="op">-</span><span class="va">time</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">data_long</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Function to plot the epidemic data</span></span>
<span><span class="va">plot_epidemic_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data_long</span>, <span class="va">t_max</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data_long</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">count</span>, color <span class="op">=</span> <span class="va">state</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"s"</span> <span class="op">=</span> <span class="st">"blue"</span>, <span class="st">"i"</span> <span class="op">=</span> <span class="st">"red"</span>, <span class="st">"y"</span> <span class="op">=</span> <span class="st">"green"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="st">"Time (Days)"</span>, y <span class="op">=</span> <span class="st">"Count"</span>,</span>
<span>      title <span class="op">=</span> <span class="st">"Susceptible, Infected, and Observed Counts"</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">t_max</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>      axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>      plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span>, hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Prepare data for plotting</span></span>
<span><span class="va">data_long</span> <span class="op">&lt;-</span> <span class="fu">prepare_data_for_plot</span><span class="op">(</span><span class="va">true_states</span>, <span class="va">observations</span>, <span class="va">t_max</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the results</span></span>
<span><span class="fu">plot_epidemic_data</span><span class="op">(</span><span class="va">data_long</span>, <span class="va">t_max</span><span class="op">)</span></span></code></pre></div>
<p><img src="detailed-overview_files/figure-html/unnamed-chunk-4-1.png" alt="Simulated epidemic data" width="576"></p>
</div>
<div class="section level3">
<h3 id="fitting-the-model">Fitting the model<a class="anchor" aria-label="anchor" href="#fitting-the-model"></a>
</h3>
<p>We define the initialization, transition, and log-likelihood
functions for the SIR model. Note, that we define all variables used in
the functions inside the functions, so that they can be used in parallel
processing (see also the tips and tricks section below).</p>
<p>The initialization function <code>init_fn</code> must take the
argument <code>num_particles</code> and return a matrix of particles,
where each row corresponds to a particle’s initial state (susceptible
and infected individuals). In this example we use a deterministic
initialization with a fixed number of susceptible and infected
individuals. The transition function <code>transition_fn</code> must
take the argument <code>particles</code> and return a matrix of
particles, where each row corresponds to a particle’s state at the next
time step. The log-likelihood function <code>log_likelihood_fn</code>
must take the arguments <code>y</code> and <code>particles</code>, and
return a vector of log-likelihood values for each particle.</p>
<p>Any time dependency can be implemented by giving a <code>t</code>
argument in the <code>transition_fn</code> and
<code>log_likelihood_fn</code>. In this example, we do not have time
dependency, so we do not use the <code>t</code> argument.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">init_fn_epidemic</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">num_particles</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Return a matrix with num_particles rows</span></span>
<span>  <span class="co"># each row is the initial state (s, i)</span></span>
<span>  <span class="va">n_total</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span>  <span class="va">init_infected</span> <span class="op">&lt;-</span> <span class="fl">70</span></span>
<span>  <span class="va">init_state</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>S <span class="op">=</span> <span class="va">n_total</span> <span class="op">-</span> <span class="va">init_infected</span>, I <span class="op">=</span> <span class="va">init_infected</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">init_state</span>, each <span class="op">=</span> <span class="va">num_particles</span><span class="op">)</span>,</span>
<span>    nrow <span class="op">=</span> <span class="va">num_particles</span>,</span>
<span>    byrow <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">transition_fn_epidemic</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">particles</span>, <span class="va">lambda</span>, <span class="va">gamma</span>, <span class="va">t</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="va">n_total</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span></span>
<span>  <span class="va">epidemic_step</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">state</span>, <span class="va">lambda</span>, <span class="va">gamma</span>, <span class="va">n_total</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">t</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>    <span class="va">t_end</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>    <span class="va">s</span> <span class="op">&lt;-</span> <span class="va">state</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>    <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">state</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>    <span class="kw">while</span> <span class="op">(</span><span class="va">t</span> <span class="op">&lt;</span> <span class="va">t_end</span> <span class="op">&amp;&amp;</span> <span class="va">i</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">rate_infection</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">lambda</span> <span class="op">/</span> <span class="va">n_total</span><span class="op">)</span> <span class="op">*</span> <span class="va">s</span> <span class="op">*</span> <span class="va">i</span></span>
<span>      <span class="va">rate_removal</span> <span class="op">&lt;-</span> <span class="va">gamma</span> <span class="op">*</span> <span class="va">i</span></span>
<span>      <span class="va">rate_total</span> <span class="op">&lt;-</span> <span class="va">rate_infection</span> <span class="op">+</span> <span class="va">rate_removal</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">rate_total</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">)</span> <span class="kw">break</span></span>
<span>      <span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">rate_total</span><span class="op">)</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">t</span> <span class="op">+</span> <span class="va">dt</span> <span class="op">&gt;</span> <span class="va">t_end</span><span class="op">)</span> <span class="kw">break</span></span>
<span>      <span class="va">t</span> <span class="op">&lt;-</span> <span class="va">t</span> <span class="op">+</span> <span class="va">dt</span></span>
<span>      <span class="co"># Decide which event occurs:</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">rate_infection</span> <span class="op">/</span> <span class="va">rate_total</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="co"># Infection event</span></span>
<span>        <span class="va">s</span> <span class="op">&lt;-</span> <span class="va">s</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>        <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">i</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="co"># Removal event</span></span>
<span>        <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">i</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">s</span>, <span class="va">i</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">new_particles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">particles</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">s</span> <span class="op">&lt;-</span> <span class="va">state</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>    <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">state</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">s</span>, <span class="va">i</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu">epidemic_step</span><span class="op">(</span><span class="va">state</span>, <span class="va">lambda</span>, <span class="va">gamma</span>, <span class="va">n_total</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">new_particles</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">log_likelihood_fn_epidemic</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span>, <span class="va">particles</span>, <span class="va">t</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># particles is expected to be a matrix with columns (s, i)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">dpois</a></span><span class="op">(</span><span class="va">y</span>, lambda <span class="op">=</span> <span class="va">particles</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>With priors for <span class="math inline">\lambda, \gamma</span> as
<span class="math display">\begin{align*}
    \lambda &amp;\sim \operatorname{Normal^+}(0, 1^2), \\
    \gamma &amp;\sim \operatorname{Normal^+}(0, 2^2).
\end{align*}</span></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">log_prior_lambda</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">lambda</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">extraDistr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/extraDistr/man/HalfNormal.html" class="external-link">dhnorm</a></span><span class="op">(</span><span class="va">lambda</span>, sigma <span class="op">=</span> <span class="fl">1</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">log_prior_gamma</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">gamma</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">extraDistr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/extraDistr/man/HalfNormal.html" class="external-link">dhnorm</a></span><span class="op">(</span><span class="va">gamma</span>, sigma <span class="op">=</span> <span class="fl">2</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">log_priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  lambda <span class="op">=</span> <span class="va">log_prior_lambda</span>,</span>
<span>  gamma <span class="op">=</span> <span class="va">log_prior_gamma</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now we can run the PMMH algorithm to estimate the posterior
distribution (we modify the tuning and only draw 1000 samples to speed
it up).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pmmh.html">pmmh</a></span><span class="op">(</span></span>
<span>  y <span class="op">=</span> <span class="va">observations</span>,</span>
<span>  m <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  init_fn <span class="op">=</span> <span class="va">init_fn_epidemic</span>,</span>
<span>  transition_fn <span class="op">=</span> <span class="va">transition_fn_epidemic</span>,</span>
<span>  log_likelihood_fn <span class="op">=</span> <span class="va">log_likelihood_fn_epidemic</span>,</span>
<span>  log_priors <span class="op">=</span> <span class="va">log_priors</span>,</span>
<span>  pilot_init_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="fl">0.5</span>, gamma <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="fl">1</span>, gamma <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  burn_in <span class="op">=</span> <span class="fl">200</span>,</span>
<span>  num_chains <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  tune_control <span class="op">=</span> <span class="fu"><a href="../reference/default_tune_control.html">default_tune_control</a></span><span class="op">(</span>pilot_m <span class="op">=</span> <span class="fl">100</span>, pilot_burn_in <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">1405</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Running chain 1...</span></span>
<span><span class="co">#&gt; Running pilot chain for tuning...</span></span>
<span><span class="co">#&gt; Pilot chain posterior mean:</span></span>
<span><span class="co">#&gt;    lambda     gamma </span></span>
<span><span class="co">#&gt; 0.4884500 0.1862124</span></span>
<span><span class="co">#&gt; Pilot chain posterior covariance:</span></span>
<span><span class="co">#&gt;             lambda        gamma</span></span>
<span><span class="co">#&gt; lambda 0.004595206 0.0011484070</span></span>
<span><span class="co">#&gt; gamma  0.001148407 0.0003359767</span></span>
<span><span class="co">#&gt; Using 50 particles for PMMH:</span></span>
<span><span class="co">#&gt; Running Particle MCMC chain with tuned settings...</span></span>
<span><span class="co">#&gt; Running chain 2...</span></span>
<span><span class="co">#&gt; Running pilot chain for tuning...</span></span>
<span><span class="co">#&gt; Pilot chain posterior mean:</span></span>
<span><span class="co">#&gt;    lambda     gamma </span></span>
<span><span class="co">#&gt; 0.6228020 0.2469006</span></span>
<span><span class="co">#&gt; Pilot chain posterior covariance:</span></span>
<span><span class="co">#&gt;               lambda         gamma</span></span>
<span><span class="co">#&gt; lambda  0.0045776235 -0.0002264161</span></span>
<span><span class="co">#&gt; gamma  -0.0002264161  0.0024275942</span></span>
<span><span class="co">#&gt; Using 50 particles for PMMH:</span></span>
<span><span class="co">#&gt; Running Particle MCMC chain with tuned settings...</span></span>
<span><span class="co">#&gt; PMMH Results Summary:</span></span>
<span><span class="co">#&gt;  Parameter Mean   SD Median 2.5% 97.5% ESS  Rhat</span></span>
<span><span class="co">#&gt;     lambda 0.54 0.08   0.54 0.41  0.69  60 1.036</span></span>
<span><span class="co">#&gt;      gamma 0.20 0.02   0.21 0.15  0.24  70 1.039</span></span>
<span><span class="co">#&gt; Warning in pmmh(y = observations, m = 1000, init_fn = init_fn_epidemic, : Some</span></span>
<span><span class="co">#&gt; ESS values are below 400, indicating poor mixing. Consider running the chains</span></span>
<span><span class="co">#&gt; for more iterations.</span></span>
<span><span class="co">#&gt; Warning in pmmh(y = observations, m = 1000, init_fn = init_fn_epidemic, : </span></span>
<span><span class="co">#&gt; Some Rhat values are above 1.01, indicating that the chains have not converged. </span></span>
<span><span class="co">#&gt; Consider running the chains for more iterations and/or increase burn_in.</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="tips-and-tricks">Tips and Tricks<a class="anchor" aria-label="anchor" href="#tips-and-tricks"></a>
</h2>
<div class="section level3">
<h3 id="using-several-cores">Using Several Cores<a class="anchor" aria-label="anchor" href="#using-several-cores"></a>
</h3>
<p>To use several cores (up to the number of chains), you can set the
<code>num_cores</code> argument in the <code>pmmh</code> function. The
code below will run the PMMH algorithm using 2 cores, which is useful
for speeding up the sampling process, especially for larger datasets or
more complex models.</p>
<p>Note, that all global variables must be explicitly defined within the
functions that are exported to the worker processes. I.e, the
<code>n_total</code>, <code>init_infected</code>, and
<code>init_state</code> variables must be defined within the
<code>init_fn_epidemic</code>, <code>transition_fn_epidemic</code>, and
<code>log_likelihood_fn_epidemic</code> functions, as shown above.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pmmh.html">pmmh</a></span><span class="op">(</span></span>
<span>  y <span class="op">=</span> <span class="va">observations</span>,</span>
<span>  m <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  init_fn <span class="op">=</span> <span class="va">init_fn_epidemic</span>,</span>
<span>  transition_fn <span class="op">=</span> <span class="va">transition_fn_epidemic</span>,</span>
<span>  log_likelihood_fn <span class="op">=</span> <span class="va">log_likelihood_fn_epidemic</span>,</span>
<span>  log_priors <span class="op">=</span> <span class="va">log_priors</span>,</span>
<span>  pilot_init_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="fl">0.5</span>, gamma <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="fl">1</span>, gamma <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  burn_in <span class="op">=</span> <span class="fl">200</span>,</span>
<span>  num_chains <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  tune_control <span class="op">=</span> <span class="fu"><a href="../reference/default_tune_control.html">default_tune_control</a></span><span class="op">(</span>pilot_m <span class="op">=</span> <span class="fl">100</span>, pilot_burn_in <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">1405</span>,</span>
<span>  num_cores <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="sampling-on-an-unconstrained-space">Sampling on an Unconstrained Space<a class="anchor" aria-label="anchor" href="#sampling-on-an-unconstrained-space"></a>
</h3>
<p>To allow for more efficient sampling, we can use the
<code>param_transform</code> argument to propose new parameters on an
unconstrained space, leading to more efficient sampling. Since <span class="math inline">\lambda</span> and <span class="math inline">\gamma</span> both take values in <span class="math inline">(0, \infty)</span>, we can use the <code>log</code>
transformation.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pmmh.html">pmmh</a></span><span class="op">(</span></span>
<span>  y <span class="op">=</span> <span class="va">observations</span>,</span>
<span>  m <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  init_fn <span class="op">=</span> <span class="va">init_fn_epidemic</span>,</span>
<span>  transition_fn <span class="op">=</span> <span class="va">transition_fn_epidemic</span>,</span>
<span>  log_likelihood_fn <span class="op">=</span> <span class="va">log_likelihood_fn_epidemic</span>,</span>
<span>  log_priors <span class="op">=</span> <span class="va">log_priors</span>,</span>
<span>  pilot_init_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="fl">0.5</span>, gamma <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="fl">1</span>, gamma <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  burn_in <span class="op">=</span> <span class="fl">200</span>,</span>
<span>  num_chains <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  tune_control <span class="op">=</span> <span class="fu"><a href="../reference/default_tune_control.html">default_tune_control</a></span><span class="op">(</span>pilot_m <span class="op">=</span> <span class="fl">100</span>, pilot_burn_in <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">1405</span>,</span>
<span>  param_transform <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="st">"log"</span>, gamma <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="using-rcpp">Using Rcpp<a class="anchor" aria-label="anchor" href="#using-rcpp"></a>
</h3>
<p>If the transition and log-likelihood functions are computationally
expensive, you can speed up the sampling process by using Rcpp to
implement the functions in C++. Here is an example of how to do this for
the transition function of the SIR model.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Rcpp/man/cppFunction.html" class="external-link">cppFunction</a></span><span class="op">(</span><span class="st">"</span></span>
<span><span class="st">NumericMatrix transition_fn_epidemic_cpp(</span></span>
<span><span class="st">    NumericMatrix particles, </span></span>
<span><span class="st">    double lambda, </span></span>
<span><span class="st">    double gamma</span></span>
<span><span class="st">) {</span></span>
<span><span class="st"></span></span>
<span><span class="st">  int n_particles = particles.nrow();</span></span>
<span><span class="st">  int n_total = 500;</span></span>
<span><span class="st">  double t_end = 1.0; // Time step for the transition</span></span>
<span><span class="st">  NumericMatrix new_particles(n_particles, 2);</span></span>
<span><span class="st">  </span></span>
<span><span class="st">  for (int p = 0; p &lt; n_particles; p++) {</span></span>
<span><span class="st">    int s = particles(p, 0);</span></span>
<span><span class="st">    int i = particles(p, 1);</span></span>
<span><span class="st">    </span></span>
<span><span class="st">    if (i == 0) {</span></span>
<span><span class="st">      new_particles(p, 0) = s;</span></span>
<span><span class="st">      new_particles(p, 1) = i;</span></span>
<span><span class="st">      continue;</span></span>
<span><span class="st">    }</span></span>
<span><span class="st">    </span></span>
<span><span class="st">    double t = 0.0;</span></span>
<span><span class="st">    </span></span>
<span><span class="st">    while (t &lt; t_end &amp;&amp; i &gt; 0) {</span></span>
<span><span class="st">      double rate_infection = (lambda / n_total) * s * i;</span></span>
<span><span class="st">      double rate_removal = gamma * i;</span></span>
<span><span class="st">      double rate_total = rate_infection + rate_removal;</span></span>
<span><span class="st">      </span></span>
<span><span class="st">      if (rate_total &lt;= 0.0) {</span></span>
<span><span class="st">        break;</span></span>
<span><span class="st">      }</span></span>
<span><span class="st">      </span></span>
<span><span class="st">      double dt = R::rexp(1.0 / rate_total);</span></span>
<span><span class="st">      if (t + dt &gt; t_end) {</span></span>
<span><span class="st">        break;</span></span>
<span><span class="st">      }</span></span>
<span><span class="st">      </span></span>
<span><span class="st">      t += dt;</span></span>
<span><span class="st">      </span></span>
<span><span class="st">      if (R::runif(0.0, 1.0) &lt; (rate_infection / rate_total)) {</span></span>
<span><span class="st">        // Infection event</span></span>
<span><span class="st">        s -= 1;</span></span>
<span><span class="st">        i += 1;</span></span>
<span><span class="st">      } else {</span></span>
<span><span class="st">        // Removal event</span></span>
<span><span class="st">        i -= 1;</span></span>
<span><span class="st">      }</span></span>
<span><span class="st">    }</span></span>
<span><span class="st">    </span></span>
<span><span class="st">    new_particles(p, 0) = s;</span></span>
<span><span class="st">    new_particles(p, 1) = i;</span></span>
<span><span class="st">  }</span></span>
<span><span class="st">  </span></span>
<span><span class="st">  return new_particles;</span></span>
<span><span class="st">}</span></span>
<span><span class="st">"</span><span class="op">)</span></span></code></pre></div>
<p>This C++ implementation is much faster than the R implementation,
which will speed up the PMMH sampling process significantly, especially
for larger datasets or more complex models.</p>
<p>Now, we can use this C++ function in the <code>pmmh</code> function
by passing it as the <code>transition_fn</code> argument.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result_cpp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pmmh.html">pmmh</a></span><span class="op">(</span></span>
<span>  y <span class="op">=</span> <span class="va">observations</span>,</span>
<span>  m <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  init_fn <span class="op">=</span> <span class="va">init_fn_epidemic</span>,</span>
<span>  transition_fn <span class="op">=</span> <span class="va">transition_fn_epidemic_cpp</span>,</span>
<span>  log_likelihood_fn <span class="op">=</span> <span class="va">log_likelihood_fn_epidemic</span>,</span>
<span>  log_priors <span class="op">=</span> <span class="va">log_priors</span>,</span>
<span>  pilot_init_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="fl">0.5</span>, gamma <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="fl">1</span>, gamma <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  burn_in <span class="op">=</span> <span class="fl">200</span>,</span>
<span>  num_chains <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  tune_control <span class="op">=</span> <span class="fu"><a href="../reference/default_tune_control.html">default_tune_control</a></span><span class="op">(</span>pilot_m <span class="op">=</span> <span class="fl">100</span>, pilot_burn_in <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">1405</span>,</span>
<span>  param_transform <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="st">"log"</span>, gamma <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Running chain 1...</span></span>
<span><span class="co">#&gt; Running pilot chain for tuning...</span></span>
<span><span class="co">#&gt; Pilot chain posterior mean:</span></span>
<span><span class="co">#&gt;    lambda     gamma </span></span>
<span><span class="co">#&gt; 0.5744942 0.2023182</span></span>
<span><span class="co">#&gt; Pilot chain posterior covariance (on transformed space):</span></span>
<span><span class="co">#&gt;              lambda        gamma</span></span>
<span><span class="co">#&gt; lambda 0.0049477745 0.0008807493</span></span>
<span><span class="co">#&gt; gamma  0.0008807493 0.0001576646</span></span>
<span><span class="co">#&gt; Using 50 particles for PMMH:</span></span>
<span><span class="co">#&gt; Running Particle MCMC chain with tuned settings...</span></span>
<span><span class="co">#&gt; Running chain 2...</span></span>
<span><span class="co">#&gt; Running pilot chain for tuning...</span></span>
<span><span class="co">#&gt; Pilot chain posterior mean:</span></span>
<span><span class="co">#&gt;    lambda     gamma </span></span>
<span><span class="co">#&gt; 0.5228747 0.1919012</span></span>
<span><span class="co">#&gt; Pilot chain posterior covariance (on transformed space):</span></span>
<span><span class="co">#&gt;              lambda        gamma</span></span>
<span><span class="co">#&gt; lambda 0.0018259219 0.0005323758</span></span>
<span><span class="co">#&gt; gamma  0.0005323758 0.0001830201</span></span>
<span><span class="co">#&gt; Using 50 particles for PMMH:</span></span>
<span><span class="co">#&gt; Running Particle MCMC chain with tuned settings...</span></span>
<span><span class="co">#&gt; PMMH Results Summary:</span></span>
<span><span class="co">#&gt;  Parameter Mean   SD Median 2.5% 97.5% ESS  Rhat</span></span>
<span><span class="co">#&gt;     lambda 0.57 0.07   0.56 0.42  0.72 109 1.012</span></span>
<span><span class="co">#&gt;      gamma 0.21 0.02   0.21 0.17  0.24  70 1.020</span></span>
<span><span class="co">#&gt; Warning in pmmh(y = observations, m = 1000, init_fn = init_fn_epidemic, : Some</span></span>
<span><span class="co">#&gt; ESS values are below 400, indicating poor mixing. Consider running the chains</span></span>
<span><span class="co">#&gt; for more iterations.</span></span>
<span><span class="co">#&gt; Warning in pmmh(y = observations, m = 1000, init_fn = init_fn_epidemic, : </span></span>
<span><span class="co">#&gt; Some Rhat values are above 1.01, indicating that the chains have not converged. </span></span>
<span><span class="co">#&gt; Consider running the chains for more iterations and/or increase burn_in.</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="observation-times">Observation Times<a class="anchor" aria-label="anchor" href="#observation-times"></a>
</h3>
<p>The <code>bayesSSM</code> package allows you to specify the
observation times for the observations. This is useful if the
observations are not equally spaced in time. You can specify the
observation times using the <code>obs_times</code> argument in the
<code>pmmh</code> function. The observation times should be a vector of
the same length as the observations, and it should contain the time
points at which the observations were made.</p>
<p>Here is an example of how to use the <code>obs_times</code> argument,
where we assume that the observations were made at times 1, 2, 3 and
6.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obs_times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">6</span><span class="op">)</span></span>
<span><span class="va">new_observations</span> <span class="op">&lt;-</span> <span class="va">observations</span><span class="op">[</span><span class="va">obs_times</span><span class="op">]</span></span>
<span><span class="va">result_obs_times</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pmmh.html">pmmh</a></span><span class="op">(</span></span>
<span>  y <span class="op">=</span> <span class="va">new_observations</span>,</span>
<span>  m <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  init_fn <span class="op">=</span> <span class="va">init_fn_epidemic</span>,</span>
<span>  transition_fn <span class="op">=</span> <span class="va">transition_fn_epidemic</span>,</span>
<span>  log_likelihood_fn <span class="op">=</span> <span class="va">log_likelihood_fn_epidemic</span>,</span>
<span>  log_priors <span class="op">=</span> <span class="va">log_priors</span>,</span>
<span>  pilot_init_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="fl">0.5</span>, gamma <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="fl">1</span>, gamma <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  burn_in <span class="op">=</span> <span class="fl">200</span>,</span>
<span>  num_chains <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  tune_control <span class="op">=</span> <span class="fu"><a href="../reference/default_tune_control.html">default_tune_control</a></span><span class="op">(</span>pilot_m <span class="op">=</span> <span class="fl">100</span>, pilot_burn_in <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">1405</span>,</span>
<span>  param_transform <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="st">"log"</span>, gamma <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span>,</span>
<span>  obs_times <span class="op">=</span> <span class="va">obs_times</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="specifying-prior-on-a-different-scale">Specifying Prior on a Different Scale<a class="anchor" aria-label="anchor" href="#specifying-prior-on-a-different-scale"></a>
</h3>
<p>Sometimes, it is useful to specify the prior on a different scale
than the parameter space. For instance, it is common to specify the
prior for the over-dispersion parameter <span class="math inline">\phi</span> in a negative binomial model on a
different scale, such as <span class="math display">
\frac{1}{\sqrt{\phi}} \sim \operatorname{Normal^+}(0, 1),
</span> where <span class="math inline">\operatorname{Normal^+}(0,
1)</span> is a truncated normal distribution on the positive real line.
To do this, you need to add the log_jacobian of the transformation in
the specified log-prior function. This is shown in the following
function, which implements the prior for <span class="math inline">\phi</span> on the scale of <span class="math inline">\frac{1}{\sqrt{\phi}}</span>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">log_prior_phi</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">phi</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">phi</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="co"># Ensure phi is positive</span></span>
<span></span>
<span>  <span class="co"># Jacobian: |d(1/sqrt(phi))/dphi| = 1/(2 * phi^(3/2))</span></span>
<span>  <span class="va">log_jacobian</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1.5</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">phi</span><span class="op">)</span></span>
<span>  <span class="fu">extraDistr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/extraDistr/man/HalfNormal.html" class="external-link">dhnorm</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">phi</span><span class="op">)</span>, sigma <span class="op">=</span> <span class="fl">1</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> <span class="va">log_jacobian</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>In this article, we have provided a detailed overview of the
<code>bayesSSM</code> package and how to use it for Bayesian inference
in state space models. We have shown how to define the model, simulate
data, and fit the model using the PMMH algorithm. We also provided some
tips and tricks for using the package effectively, including how to use
several cores, sample on an unconstrained space, and use Rcpp for faster
sampling.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Bjarke Hautop.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
